apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "wh2pg.fullname" . }}-init-db
  labels:
    {{- include "wh2pg.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    metadata:
      labels:
        {{- include "wh2pg.selectorLabels" . | nindent 8 }}
    spec:
      restartPolicy: OnFailure
      containers:
      - name: init-db
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        command: ["/app/wh2pg"]
        # We can add a specific flag or env var to only run migrations if needed
        # For now, the app runs init_db on startup anyway, so this job is just to ensure it's ready
        # Or we could use a separate migration tool here
        env:
        - name: DB_HOST
          value: {{ include "wh2pg.postgresql.host" . | quote }}
        - name: DB_PORT
          value: {{ include "wh2pg.postgresql.port" . | quote }}
        - name: DB_NAME
          value: {{ include "wh2pg.postgresql.database" . | quote }}
        - name: DB_USER
          value: {{ include "wh2pg.postgresql.username" . | quote }}
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "wh2pg.postgresql.secretName" . }}
              key: {{ .Values.postgresql.external.existingSecretPasswordKey | default "password" }}
        - name: DB_SSL_MODE
          value: {{ .Values.postgresql.external.sslMode | default "require" | quote }}
        - name: RUN_INIT_ONLY
          value: "true"
