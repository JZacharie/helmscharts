{{- if .Values.cronjob.enabled -}}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "shannon.fullname" . }}-scheduled-scan
  labels:
    {{- include "shannon.labels" . | nindent 4 }}
spec:
  schedule: {{ .Values.cronjob.schedule | quote }}
  suspend: {{ .Values.cronjob.suspend }}
  jobTemplate:
    spec:
      template:
        spec:
          securityContext:
            runAsUser: 0
          containers:
            - name: shannon
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
              securityContext:
                privileged: true
              env:
                - name: ANTHROPIC_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "shannon.fullname" . }}-secrets
                      key: anthropic-api-key
                - name: CLAUDE_CODE_MAX_OUTPUT_TOKENS
                  value: {{ .Values.shannon.maxOutputTokens | quote }}
                - name: DOCKER_TLS_CERTDIR
                  value: ""
                - name: TARGET_URL
                  value: {{ .Values.cronjob.targetUrl | quote }}
                - name: TARGET_REPO
                  value: {{ .Values.cronjob.targetRepo | quote }}
              resources:
                {{- toYaml .Values.resources | nindent 16 }}
              volumeMounts:
                - name: data
                  mountPath: /data
                - name: docker-graph
                  mountPath: /var/lib/docker
              command:
                - sh
                - -c
                - |
                  dockerd-entrypoint.sh &
                  sleep 10
                  
                  if [ ! -d "/data/shannon" ]; then
                    apk add --no-cache git
                    git clone https://github.com/KeygraphHQ/shannon.git /data/shannon
                  fi
                  
                  cd /data/shannon
                  
                  # Create repos directory
                  mkdir -p repos
                  
                  # Run the scan
                  ./shannon start URL=$TARGET_URL REPO=$TARGET_REPO OUTPUT=/data/reports
          volumes:
            - name: data
              persistentVolumeClaim:
                claimName: {{ include "shannon.fullname" . }}-data
            - name: docker-graph
              emptyDir: {}
          restartPolicy: OnFailure
{{- end }}
